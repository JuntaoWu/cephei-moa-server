var __extends=this&&this.__extends||function(e,t){function o(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)},Photon;!function(e){e.ConnectionProtocol={Ws:0,Wss:1};var t=function(){function e(e,t,o){void 0===t&&(t=""),void 0===o&&(o=""),this.url=e,this.subprotocol=t,this.keepAliveTimeoutMs=3e3,this._frame="~m~",this._isConnecting=!1,this._isConnected=!1,this._isClosing=!1,this._peerStatusListeners={},this._eventListeners={},this._responseListeners={},this.lastRtt=0,this.initTimestamp=Date.now(),this.keepAliveTimer=0,this._logger=new Exitgames.Common.Logger(o&&""!=o?o+":":"")}return e.prototype.isConnecting=function(){return this._isConnecting},e.prototype.getLastRtt=function(){return this.lastRtt},e.prototype.isConnected=function(){return this._isConnected},e.prototype.isClosing=function(){return this._isClosing},e.prototype.connect=function(){var e=this;this._sessionid=void 0,""==this.subprotocol?this._socket=new WebSocket(this.url,"Json"):this._socket=new WebSocket(this.url,this.subprotocol),this._onConnecting(),this._socket.onopen=function(e){},this._socket.onmessage=function(t){var o=e._decode(t.data);e._onMessage(o.toString())},this._socket.onclose=function(t){e._logger.debug("onclose: wasClean =",t.wasClean,", code=",t.code,", reason =",t.reason),e._isConnecting?e._onConnectFailed(t):(1006==t.code&&e._onTimeout(),e._onDisconnect())},this._socket.onerror=function(t){e._onError(t)}},e.prototype.disconnect=function(){this._isClosing=!0,this._socket.close()},e.prototype.sendOperation=function(e,t,o,r){void 0===o&&(o=!1),void 0===r&&(r=0);var n={req:e,vals:[]};if(Exitgames.Common.Util.isArray(t))n.vals=t;else{if(void 0!==t)throw new Error(this._logger.format("PhotonPeer[sendOperation] - Trying to send non array data:",t));n.vals=[]}this._send(n),this._logger.debug("PhotonPeer[sendOperation] - Sending request:",n)},e.prototype.addPeerStatusListener=function(e,t){this._addListener(this._peerStatusListeners,e,t)},e.prototype.addEventListener=function(e,t){this._addListener(this._eventListeners,e.toString(),t)},e.prototype.addResponseListener=function(e,t){this._addListener(this._responseListeners,e.toString(),t)},e.prototype.removePeerStatusListener=function(e,t){this._removeListener(this._peerStatusListeners,e,t)},e.prototype.removeEventListener=function(e,t){this._removeListener(this._eventListeners,e.toString(),t)},e.prototype.removeResponseListener=function(e,t){this._removeListener(this._responseListeners,e.toString(),t)},e.prototype.removePeerStatusListenersForCode=function(e){this._removeListenersForCode(this._peerStatusListeners,e)},e.prototype.removeEventListenersForCode=function(e){this._removeListenersForCode(this._eventListeners,e.toString())},e.prototype.removeResponseListenersForCode=function(e){this._removeListenersForCode(this._responseListeners,e.toString())},e.prototype.setLogLevel=function(e){this._logger.setLevel(e)},e.prototype.onUnhandledEvent=function(e,t){this._logger.warn("PhotonPeer: No handler for event",e,"registered.")},e.prototype.onUnhandledResponse=function(e,t){this._logger.warn("PhotonPeer: No handler for response",e,"registered.")},e.prototype._dispatchEvent=function(e,t){this._dispatch(this._eventListeners,e.toString(),t,"event")||this.onUnhandledEvent(e,t)},e.prototype._dispatchResponse=function(e,t){this._dispatch(this._responseListeners,e.toString(),t,"response")||this.onUnhandledResponse(e,t)},e.prototype._stringify=function(e){if("[object Object]"==Object.prototype.toString.call(e)){if(!JSON)throw new Error("PhotonPeer[_stringify] - Trying to encode as JSON, but JSON.stringify is missing.");return"~j~"+JSON.stringify(e)}return String(e)},e.prototype._encode=function(e){for(var t,o="",e=Exitgames.Common.Util.isArray(e)?e:[e],r=0,n=e.length;n>r;r++)t=null===e[r]||void 0===e[r]?"":this._stringify(e[r]),o+=this._frame+t.length+this._frame+t;return o},e.prototype._decode=function(e){var t,o,r=[],n=e,s=e.indexOf("\x00");-1!==s&&(n=e.replace(/[\0]/g,"")),e=n;do{if(e.substr(0,3)!==this._frame)return r;e=e.substr(3),t="",o="";for(var i=0,a=e.length;a>i;i++){if(o=Number(e.substr(i,1)),e.substr(i,1)!=o){e=e.substr(t.length+this._frame.length),t=Number(t);break}t+=o}r.push(e.substr(0,t)),e=e.substr(t)}while(""!==e);return r},e.prototype._onMessage=function(e){"~j~"==e.substr(0,3)?this._onMessageReceived(JSON.parse(e.substr(3))):this._sessionid?this._onMessageReceived(e):(this._sessionid=e,this._onConnect())},e.prototype.resetKeepAlive=function(){var e=this;clearTimeout(this.keepAliveTimer),this.keepAliveTimeoutMs>=1e3&&(this.keepAliveTimer=setTimeout(function(){e._send({irq:1,vals:[1,Date.now()-e.initTimestamp]},!0)},this.keepAliveTimeoutMs))},e.prototype._send=function(e,t){void 0===t&&(t=!1);var o=this._encode(e);if(this._isConnected&&!this._isClosing)this.resetKeepAlive(),this._socket.send(o);else if(!t)throw new Error(this._logger.format("PhotonPeer[_send] - Operation",e.req,'- failed, "isConnected" is',this._isConnected,', "isClosing" is',this._isClosing,"!"))},e.prototype._onMessageReceived=function(e){if("object"==typeof e){this._logger.debug("PhotonPeer[_onMessageReceived] - Socket received message:",e);var t=e;t.err?t.err:0;if(t.vals=void 0!==t.vals?t.vals:[],t.vals.length>0&&(t.vals=this._parseMessageValuesArrayToJSON(t.vals)),void 0!==t.res){var o=parseInt(t.res);this._parseResponse(o,t)}else if(void 0!==t.evt){var o=parseInt(t.evt);this._parseEvent(o,t)}else{if(void 0===t.irs)throw new Error(this._logger.format("PhotonPeer[_onMessageReceived] - Received undefined message type:",t));var o=parseInt(t.irs);this._parseInternalResponse(o,t)}}},e.prototype._parseMessageValuesArrayToJSON=function(e){var t={};if(Exitgames.Common.Util.isArray(e)){if(e.length%2!=0)throw new Error(this._logger.format("PhotonPeer[_parseMessageValuesToJSON] - Received invalid values array:",e));for(var o,r,n=e;n.length>0;)o=n.shift()+"",r=n.shift(),t[o]=r}return t},e.prototype._parseEvent=function(e,t){switch(e){default:this._dispatchEvent(e,{vals:t.vals})}},e.prototype._parseResponse=function(e,t){switch(e){default:this._dispatchResponse(e,{errCode:t.err,errMsg:t.msg,vals:t.vals})}},e.prototype._parseInternalResponse=function(e,t){this.lastRtt=Date.now()-this.initTimestamp-t.vals[1],this._logger.debug("internal response:",t)},e.prototype._onConnecting=function(){this._logger.debug("PhotonPeer[_onConnecting] - Starts connecting",this.url,'..., raising "connecting" event ...'),this._isConnecting=!0,this._dispatchPeerStatus(e.StatusCodes.connecting),this.resetKeepAlive()},e.prototype._onConnect=function(){this._logger.debug('PhotonPeer[_onConnect] - Connected successfully! Raising "connect" event ...'),this._isConnecting=!1,this._isConnected=!0,this._dispatchPeerStatus(e.StatusCodes.connect),this.resetKeepAlive()},e.prototype._onConnectFailed=function(t){this._logger.error("PhotonPeer[_onConnectFailed] - Socket connection could not be created:",this.url,this.subprotocol,'Wrong host or port?\n Raising "connectFailed event ...'),this._isConnecting=this._isConnected=!1,this._dispatchPeerStatus(e.StatusCodes.connectFailed)},e.prototype._onDisconnect=function(){var t=this._isConnected,o=this._isClosing;this._logger.debug('PhotonPeer[_onDisconnect] - Socket closed, raising "disconnect" event ...'),this._isClosing=this._isConnected=this._isConnecting=!1,t&&(o?this._dispatchPeerStatus(e.StatusCodes.disconnect):this._dispatchPeerStatus(e.StatusCodes.connectClosed))},e.prototype._onTimeout=function(){this._logger.debug('PhotonPeer[_onTimeout] - Client timed out! Raising "timeout" event ...'),this._dispatchPeerStatus(e.StatusCodes.timeout)},e.prototype._onError=function(t){this._logger.error("PhotonPeer[_onError] - Connection error:",arguments[0]),this._isConnecting=this._isConnected=this._isClosing=!1,this._dispatchPeerStatus(e.StatusCodes.error)},e.prototype._addListener=function(e,t,o){return t in e||(e[t]=[]),o&&"function"==typeof o?(this._logger.debug("PhotonPeer[_addListener] - Adding listener for event",t),e[t].push(o)):this._logger.error("PhotonPeer[_addListener] - Listener",t,"is not a function but of type",typeof o,". No listener added!"),this},e.prototype._dispatch=function(e,t,o,r){if(t in e){for(var n=e[t],s=0,i=n.length;i>s;s++)Exitgames.Common.Util.isArray(o)||(o=[o]),n[s].apply(this,void 0===o?[]:o);return!0}return!1},e.prototype._dispatchPeerStatus=function(e){this._dispatch(this._peerStatusListeners,e,void 0,"peerStatus")||this._logger.warn("PhotonPeer[_dispatchPeerStatus] - No handler for ",e,"registered.")},e.prototype._removeListener=function(e,t,o){if(t in e){var r=e[t].length;e[t]=e[t].filter(function(e){return e!=o}),this._logger.debug("PhotonPeer[_removeListener] - Removing listener for event",t,"removed:",r-e[t].length)}return this},e.prototype._removeListenersForCode=function(e,t){return this._logger.debug("PhotonPeer[_removeListenersForCode] - Removing all listeners for event",t),t in e&&(e[t]=[]),this},e.StatusCodes={connecting:"connecting",connect:"connect",connectFailed:"connectFailed",disconnect:"disconnect",connectClosed:"connectClosed",error:"error",timeout:"timeout"},e}();e.PhotonPeer=t}(Photon||(Photon={}));var Exitgames;!function(e){var t;!function(e){var t=function(){function e(t,o){void 0===t&&(t=""),void 0===o&&(o=e.Level.INFO),this.prefix=t,this.level=o}return e.prototype.setLevel=function(t){t=Math.max(t,e.Level.DEBUG),t=Math.min(t,e.Level.OFF),this.level=t},e.prototype.isLevelEnabled=function(e){return e>=this.level},e.prototype.getLevel=function(){return this.level},e.prototype.debug=function(t){for(var o=[],r=1;r<arguments.length;r++)o[r-1]=arguments[r];this.log(e.Level.DEBUG,t,o)},e.prototype.info=function(t){for(var o=[],r=1;r<arguments.length;r++)o[r-1]=arguments[r];this.log(e.Level.INFO,t,o)},e.prototype.warn=function(t){for(var o=[],r=1;r<arguments.length;r++)o[r-1]=arguments[r];this.log(e.Level.WARN,t,o)},e.prototype.error=function(t){for(var o=[],r=1;r<arguments.length;r++)o[r-1]=arguments[r];this.log(e.Level.ERROR,t,o)},e.prototype.format=function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];return this.format0(e,t)},e.prototype.formatArr=function(e,t){return this.format0(e,t)},e.prototype.log=function(t,o,r){if(t>=this.level&&"undefined"!=typeof console&&void 0!==o)try{var n=console[e.log_types[t]];n||(n=console.log),n&&(n.call?n.call(console,this.format0(o,r)):n(console,this.format0(o,r)))}catch(s){}},e.prototype.format0=function(e,t){return(""==this.prefix?"":this.prefix+" ")+e+" "+t.map(function(e){if(void 0!==e)switch(typeof e){case"object":try{return JSON.stringify(e)}catch(t){return e.toString()+"("+t+")"}default:return e.toString()}}).join(" ")},e.Level={DEBUG:1,INFO:2,WARN:3,ERROR:4,OFF:6},e.log_types=["debug","debug","info","warn","error"],e}();e.Logger=t;var o=function(){function e(){}return e.indexOf=function(e,t,o){for(var r=e.length,n=0>o?Math.max(0,r+o):o||0;r>n;n++)if(e[n]===t)return n;return-1},e.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},e.merge=function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])},e.getPropertyOrElse=function(e,t,o){return e.hasOwnProperty(t)?e[t]:o},e.enumValueToName=function(e,t){for(var o in e)if(t==e[o])return o;return"undefined"},e.getEnumKeyByValue=function(e,t){for(var o in e)if(t==e[o])return o},e}();e.Util=o}(t=e.Common||(e.Common={}))}(Exitgames||(Exitgames={}));var Photon;!function(e){var t;!function(e){var t;!function(e){e.LiteOpKey={ActorList:252,ActorNr:254,ActorProperties:249,Add:238,Broadcast:250,Cache:247,Code:244,Data:245,GameId:255,GameProperties:248,Group:240,Properties:251,ReceiverGroup:246,Remove:239,TargetActorNr:253,EmptyRoomLiveTime:236},e.LiteEventCode={Join:255,Leave:254,PropertiesChanged:253},e.LiteOpCode={ChangeGroups:248,GetProperties:251,Join:255,Leave:254,RaiseEvent:253,SetProperties:252}}(t=e.Constants||(e.Constants={}))}(t=e.Lite||(e.Lite={}))}(Photon||(Photon={}));var Photon;!function(e){var t;!function(t){var o=function(o){function r(t,r){var n=this;void 0===r&&(r=""),o.call(this,t,r),this.isJoined=!1,this.roomName="",this.room={properties:{}},this.actors={},this._myActor={photonId:0,properties:{}},this.addPeerStatusListener(e.PhotonPeer.StatusCodes.disconnect,function(){n.isJoined=!1})}return __extends(r,o),r.prototype.myActor=function(){return this._myActor},r.prototype.join=function(e,o,r,n){if(void 0===e||!this.isConnected()||this.isJoined)throw void 0===e?new Error("PhotonPeer.Lite[join] - Trying to join with undefined roomName!"):this.isJoined?new Error("PhotonPeer.Lite[join] - you have already joined!"):new Error("PhotonPeer.Lite[join] - Not connected!");this._logger.info("PhotonPeer.Lite[join] - Joining roomName:",e),this._logger.debug("PhotonPeer.Lite[join] - actorProperties:",r,", roomProperties:",o,", broadcast:",n);var s=[];s.push(t.Constants.LiteOpKey.GameId),s.push(e+""),"object"==typeof o&&(s.push(t.Constants.LiteOpKey.GameProperties),s.push(o)),"object"==typeof r&&(s.push(t.Constants.LiteOpKey.ActorProperties),s.push(r)),s.push(t.Constants.LiteOpKey.Broadcast),s.push(n||!1),this.sendOperation(t.Constants.LiteOpCode.Join,s)},r.prototype.leave=function(){if(!this.isJoined)throw new Error("PhotonPeer.Lite[leave] - Not joined!");this._logger.debug("PhotonPeer.Lite[leave] - Leaving ..."),this.sendOperation(t.Constants.LiteOpCode.Leave)},r.prototype.raiseEvent=function(e,o){if(!this.isJoined)throw new Error("PhotonPeer.Lite[raiseEvent] - Not joined!");if(void 0===o)throw new Error(this._logger.format("PhotonPeer.Lite[raiseEvent] - Event",e,"- data not passed in as object!"));this._logger.debug("PhotonPeer.Lite[raiseEvent] - Event",e,":",o),this.sendOperation(t.Constants.LiteOpCode.RaiseEvent,[t.Constants.LiteOpKey.Code,e,t.Constants.LiteOpKey.Data,o])},r.prototype.setActorProperties=function(e,o,r){if(!this.isJoined)throw new Error("PhotonPeer.Lite[setActorProperties] - Not joined!");this._logger.debug("PhotonPeer.Lite[setActorProperties] - actorNumber:"+e+", broadcast:"+r+", data:",o),this.sendOperation(t.Constants.LiteOpCode.SetProperties,[t.Constants.LiteOpKey.Broadcast,r,t.Constants.LiteOpKey.Properties,o,t.Constants.LiteOpKey.ActorNr,e])},r.prototype.getActorProperties=function(e,o){if(!this.isJoined)throw new Error("PhotonPeer.Lite[getProperties] - Not joined!");var r=[];r.push(t.Constants.LiteOpKey.ActorProperties),void 0!==e&&Exitgames.Common.Util.isArray(e)&&e.length>0&&r.push(e),2!==r.length&&r.push(null),r.push(t.Constants.LiteOpKey.ActorList),void 0!==o&&Exitgames.Common.Util.isArray(o)&&o.length>0&&r.push(o),4!==r.length&&r.push(null),r.push(t.Constants.LiteOpKey.Properties),r.push(2),this._logger.debug("PhotonPeer.Lite[getActorProperties] -",r),this.sendOperation(t.Constants.LiteOpCode.GetProperties,r)},r.prototype.setRoomProperties=function(e,o){if(!this.isJoined)throw new Error("PhotonPeer.Lite[setRoomProperties] - Not joined!");this._logger.debug("PhotonPeer.Lite[setRoomProperties] - broadcast:"+o+", data:",e),this.sendOperation(t.Constants.LiteOpCode.SetProperties,[t.Constants.LiteOpKey.Broadcast,o,t.Constants.LiteOpKey.Properties,e])},r.prototype.getRoomProperties=function(e){if(!this.isJoined)throw new Error("PhotonPeer.Lite[getRoomProperties] - Not joined!");var o=[];o.push(t.Constants.LiteOpKey.GameProperties),void 0!==e?Exitgames.Common.Util.isArray(e)&&e.length>0&&o.push(e):o.push(null),this._logger.debug("PhotonPeer.Lite[getRoomProperties] -",o),this.sendOperation(t.Constants.LiteOpCode.GetProperties,o)},r.prototype._addActor=function(e){return this.actors[e]={photonId:e},this._logger.debug("PhotonPeer.Lite[_addActor] - Added actorNr",e,"actors known are now ",this.actors),this.actors[e]},r.prototype._removeActor=function(e){return delete this.actors[e],this._logger.debug("PhotonPeer.Lite[_removeActor] - Removed actorNr",e,", actors known are now",this.actors),this},r.prototype.actorNrFromVals=function(t){var o=t[e.Lite.Constants.LiteOpKey.ActorNr];return void 0!==o?parseInt(o):-1},r.prototype._parseEvent=function(e,o){var r=this.actorNrFromVals(o.vals);switch(e){case t.Constants.LiteEventCode.Join:this._onEventJoin(o,r);break;case t.Constants.LiteEventCode.Leave:this._onEventLeave(r);break;case t.Constants.LiteEventCode.PropertiesChanged:this._onEventSetProperties(o,r);break;default:this._logger.info("PhotonPeer.Lite[_parseEvent] - Unknown event code",e,"with JSON:",o),this._dispatchEvent(e,{vals:o.vals,actorNr:r})}},r.prototype._onEventJoin=function(e,o){if(o!==this._myActor.photonId)this._logger.debug("PhotonPeer.Lite[_onEventJoin] - ActorNr",o,"joined."),this._addActor(o),this._dispatchEvent(t.Constants.LiteEventCode.Join,{newActors:[o]});else{var r=e.vals[t.Constants.LiteOpKey.ActorList],n=[];for(var s in r){var o=parseInt(r[s]);o!==this._myActor.photonId&&void 0===this.actors[o]&&(this._logger.debug("PhotonPeer.Lite[_onEventJoin] - ActorNr",o,"registered as already joined"),this._addActor(o),n.push(o))}this._dispatchEvent(t.Constants.LiteEventCode.Join,{newActors:n})}},r.prototype._onEventLeave=function(e){this._logger.debug("PhotonPeer.Lite[_onEventLeave] - ActorNr",e,"left"),this._removeActor(e),this._dispatchEvent(t.Constants.LiteEventCode.Leave,{actorNr:e})},r.prototype._onEventSetProperties=function(e,t){},r.prototype._parseResponse=function(e,o){var r=this.actorNrFromVals(o.vals);switch(e){case t.Constants.LiteOpCode.Join:this._onResponseJoin(r);break;case t.Constants.LiteOpCode.Leave:this._onResponseLeave(r);break;case t.Constants.LiteOpCode.RaiseEvent:break;case t.Constants.LiteOpCode.GetProperties:this._onResponseGetProperties(o);break;case t.Constants.LiteOpCode.SetProperties:this._onResponseSetProperties(o,r);break;default:this._logger.debug("PhotonPeer.Lite[_parseResponse] - Unknown response code",e,o,"actorNr",r),this._dispatchResponse(e,{errCode:o.err,errMsg:o.msg,vals:o.vals,actorNr:r})}},r.prototype._onResponseGetProperties=function(e){if(this._logger.debug("PhotonPeer.Lite[_onResponseGetProperties] - getProperties response:",e),void 0!==e.vals[t.Constants.LiteOpKey.ActorProperties]){var o=e.vals[t.Constants.LiteOpKey.ActorProperties];for(var r in o)this.actors[r].properties=o[r]}if(void 0!==e.vals[t.Constants.LiteOpKey.GameProperties]){var n=e.vals[t.Constants.LiteOpKey.GameProperties];this.room.properties=n}this._dispatchResponse(t.Constants.LiteOpCode.GetProperties,{vals:e.vals})},r.prototype._onResponseJoin=function(e){this.isJoined=!0,"object"==typeof this._myActor&&(this._myActor=this._addActor(e),this._logger.debug("PhotonPeer.Lite[_onResponseJoin] - You joined as actor number / myActor.photonId has been set to:",this._myActor.photonId)),this._dispatchResponse(t.Constants.LiteOpCode.Join,{actorNr:e})},r.prototype._onResponseLeave=function(e){this.isJoined=!1,this._removeActor(this._myActor.photonId),this._logger.debug("PhotonPeer.Lite[_onResponseLeave] - You left the room",this.roomName),this.roomName="",this.room={properties:{}},this._dispatchResponse(t.Constants.LiteOpCode.Leave,{actorNr:e})},r.prototype._onResponseSetProperties=function(e,o){this._logger.debug("PhotonPeer.Lite[_onResponseSetProperties] - setProperties response:",e,"actorNr",o),this._dispatchResponse(t.Constants.LiteOpCode.SetProperties,{vals:e.vals,actorNr:o})},r}(e.PhotonPeer);t.LitePeer=o}(t=e.Lite||(e.Lite={}))}(Photon||(Photon={}));var Photon;!function(e){var t;!function(t){var o;!function(t){var o=e.Lite.Constants.LiteOpKey,r=e.Lite.Constants.LiteOpCode,n=e.Lite.Constants.LiteEventCode;t.ErrorCode={Ok:0,OperationNotAllowedInCurrentState:-3,InvalidOperationCode:-2,InternalServerError:-1,InvalidAuthentication:32767,GameIdAlreadyExists:32766,GameFull:32765,GameClosed:32764,NoRandomMatchFound:32760,GameDoesNotExist:32758,MaxCcuReached:32757,InvalidRegion:32756},t.ActorProperties={PlayerName:255},t.GameProperties={MaxPlayers:255,IsVisible:254,IsOpen:253,PlayerCount:252,Removed:251,PropsListedInLobby:250,CleanupCacheOnLeave:249,MasterClientId:248},t.EventCode={GameList:230,GameListUpdate:229,QueueState:228,AppStats:226,AzureNodeInfo:210,Join:n.Join,Leave:n.Leave,PropertiesChanged:n.PropertiesChanged,Disconnect:252,LobbyStats:224},t.ParameterCode={Address:230,PeerCount:229,GameCount:228,MasterPeerCount:227,UserId:225,ApplicationId:224,Position:223,MatchMakingType:223,GameList:222,Secret:221,AppVersion:220,AzureNodeInfo:210,AzureLocalNodeId:209,AzureMasterNodeId:208,RoomName:o.GameId,Broadcast:o.Broadcast,ActorList:o.ActorList,ActorNr:o.ActorNr,PlayerProperties:o.ActorProperties,CustomEventContent:o.Data,Data:o.Data,Code:o.Code,GameProperties:o.GameProperties,Properties:o.Properties,TargetActorNr:o.TargetActorNr,ReceiverGroup:o.ReceiverGroup,Cache:o.Cache,CleanupCacheOnLeave:241,Group:o.Group,Remove:o.Remove,Add:o.Add,EmptyRoomTTL:o.EmptyRoomLiveTime,PlayerTTL:235,Plugins:204,ClientAuthenticationType:217,ClientAuthenticationParams:216,ClientAuthenticationData:214,JoinMode:215,MasterClientId:203,FindFriendsRequestList:1,FindFriendsResponseOnlineList:1,FindFriendsResponseRoomIdList:2,LobbyName:213,LobbyType:212,LobbyStats:211,Region:210,IsInactive:233,CheckUserOnJoin:232,ExpectedValues:231,UriPath:209,RpcCallParams:208,RpcCallRetCode:207,RpcCallRetMessage:206,RpcCallRetData:208,Forward:234,Nickname:202},t.OperationCode={Authenticate:230,JoinLobby:229,LeaveLobby:228,CreateGame:227,JoinGame:226,JoinRandomGame:225,Leave:r.Leave,RaiseEvent:r.RaiseEvent,SetProperties:r.SetProperties,GetProperties:r.GetProperties,ChangeGroups:r.ChangeGroups,FindFriends:222,LobbyStats:221,GetRegions:220,Rpc:219},t.MatchmakingMode={FillRoom:0,SerialMatching:1,RandomMatching:2},t.EventCaching={DoNotCache:0,MergeCache:1,ReplaceCache:2,RemoveCache:3,AddToRoomCache:4,AddToRoomCacheGlobal:5,RemoveFromRoomCache:6,RemoveFromRoomCacheForActorsLeft:7},t.ReceiverGroup={Others:0,All:1,MasterClient:2},t.CustomAuthenticationType={Custom:0,Steam:1,Facebook:2,None:255},t.LobbyType={Default:0,SqlLobby:2}}(o=t.Constants||(t.Constants={}))}(t=e.LoadBalancing||(e.LoadBalancing={}))}(Photon||(Photon={}));var Photon;!function(e){var t;!function(t){function o(t,o){for(var n in r)if(0==t.indexOf(r[n]))return t;switch(o){case e.ConnectionProtocol.Ws:return r.ws+t;case e.ConnectionProtocol.Wss:return r.wss+t;default:return r.ws+t}}var r={ws:"ws://",wss:"wss://"},n=function(){function e(e,t,o){this.name=e,this.actorNr=t,this.isLocal=o,this.customProperties={},this.suspended=!1}return e.prototype.getRoom=function(){return this.loadBalancingClient.myRoom()},e.prototype.raiseEvent=function(e,t,o){this.loadBalancingClient&&this.loadBalancingClient.raiseEvent(e,t,o)},e.prototype.setName=function(e){this.name=e},e.prototype.onPropertiesChange=function(e,t){},e.prototype.getCustomProperty=function(e){return this.customProperties[e]},e.prototype.getCustomPropertyOrElse=function(e,t){return Exitgames.Common.Util.getPropertyOrElse(this.customProperties,e,t)},e.prototype.setCustomProperty=function(e,t,o,r){void 0===o&&(o=!1),this.customProperties[e]=t;var n={};n[e]=t;var s;void 0!=r&&(i={},i[e]=r,s=i),this.loadBalancingClient&&this.loadBalancingClient.isJoinedToRoom()&&this.loadBalancingClient._setPropertiesOfActor(this.actorNr,n,o,s),this.onPropertiesChange(n,!0);var i},e.prototype.setCustomProperties=function(e,t,o){void 0===t&&(t=!1);var r={};for(var n in e)this.customProperties[n]=e[n],r[n]=e[n];this.loadBalancingClient&&this.loadBalancingClient.isJoinedToRoom()&&this.loadBalancingClient._setPropertiesOfActor(this.actorNr,r,t,o),this.onPropertiesChange(r,!0)},e.prototype.getJoinToken=function(){return this.joinToken},e.prototype.isSuspended=function(){return this.suspended},e.prototype._getAllProperties=function(){var e={};e[t.Constants.ActorProperties.PlayerName]=this.name;for(var o in this.customProperties)e[o]=this.customProperties[o];return e},e.prototype._setLBC=function(e){this.loadBalancingClient=e},e.prototype._updateFromResponse=function(e){this.actorNr=e[t.Constants.ParameterCode.ActorNr];var o=e[t.Constants.ParameterCode.PlayerProperties];if(void 0!==o){var r=o[t.Constants.ActorProperties.PlayerName];void 0!==r&&(this.name=r),this._updateCustomProperties(o)}},e.prototype._updateMyActorFromResponse=function(e){this.actorNr=e[t.Constants.ParameterCode.ActorNr],this.joinToken=this.actorNr?this.actorNr.toString():null},e.prototype._updateCustomProperties=function(e){for(var t in e)this.customProperties[t]=e[t];this.onPropertiesChange(e,!1)},e.prototype._setSuspended=function(e){this.suspended=e},e._getActorNrFromResponse=function(e){return e[t.Constants.ParameterCode.ActorNr]},e}();t.Actor=n;var s=function(){function e(e){this.name="",this.address="",this.maxPlayers=0,this.isVisible=!0,this.isOpen=!0,this.playerCount=0,this.emptyRoomLiveTime=0,this.suspendedPlayerLiveTime=0,this.uniqueUserId=!1,this.removed=!1,this.cleanupCacheOnLeave=!1,this.masterClientId=0,this._customProperties={},this._propsListedInLobby=[],this.name=e}return e.prototype.onPropertiesChange=function(e,t){},e.prototype.getCustomProperty=function(e){return this._customProperties[e]},e.prototype.getCustomPropertyOrElse=function(e,t){return Exitgames.Common.Util.getPropertyOrElse(this._customProperties,e,t)},e.prototype._updateFromMasterResponse=function(e){this.address=e[t.Constants.ParameterCode.Address];var o=e[t.Constants.ParameterCode.RoomName];o&&(this.name=o)},e.prototype._updateFromProps=function(e){if(e){this.maxPlayers=this.updateIfExists(this.maxPlayers,t.Constants.GameProperties.MaxPlayers,e),this.isVisible=this.updateIfExists(this.isVisible,t.Constants.GameProperties.IsVisible,e),this.isOpen=this.updateIfExists(this.isOpen,t.Constants.GameProperties.IsOpen,e),this.playerCount=this.updateIfExists(this.playerCount,t.Constants.GameProperties.PlayerCount,e),this.removed=this.updateIfExists(this.removed,t.Constants.GameProperties.Removed,e),this._propsListedInLobby=this.updateIfExists(this._propsListedInLobby,t.Constants.GameProperties.PropsListedInLobby,e),this.cleanupCacheOnLeave=this.updateIfExists(this.cleanupCacheOnLeave,t.Constants.GameProperties.CleanupCacheOnLeave,e),this.masterClientId=this.updateIfExists(this.masterClientId,t.Constants.GameProperties.MasterClientId,e);var o={};for(var r in e)parseInt(r).toString()!=r&&this._customProperties[r]!==e[r]&&(this._customProperties[r]=e[r],o[r]=e[r]);this.onPropertiesChange(o,!1)}},e.prototype._updateFromEvent=function(e){e&&(this.masterClientId=this.updateIfExists(this.masterClientId,t.Constants.ParameterCode.MasterClientId,e))},e.prototype.updateIfExists=function(e,t,o){return o.hasOwnProperty(t)?o[t]:e},e}();t.RoomInfo=s;var i=function(e){function o(t){e.call(this,t)}return __extends(o,e),o.prototype.setCustomProperty=function(e,t,o,r){void 0===o&&(o=!1),this._customProperties[e]=t;var n={};n[e]=t;var s;void 0!=r&&(i={},i[e]=r,s=i),this.loadBalancingClient&&this.loadBalancingClient.isJoinedToRoom()&&this.loadBalancingClient._setPropertiesOfRoom(n,o,s),this.onPropertiesChange(n,!0);var i},o.prototype.setCustomProperties=function(e,t,o){void 0===t&&(t=!1);var r={};for(var n in e)this._customProperties[n]=e[n],r[n]=e[n];this.loadBalancingClient&&this.loadBalancingClient.isJoinedToRoom()&&this.loadBalancingClient._setPropertiesOfRoom(r,t,o),this.onPropertiesChange(r,!0)},o.prototype.setProp=function(e,t){if(this.loadBalancingClient&&this.loadBalancingClient.isJoinedToRoom()){var o={};o[e]=t,this.loadBalancingClient._setPropertiesOfRoom(o,!1,void 0)}},o.prototype.setIsVisible=function(e){this.isVisible!=e&&(this.isVisible=e,this.setProp(t.Constants.GameProperties.IsVisible,e))},o.prototype.setIsOpen=function(e){this.isOpen!=e&&(this.isOpen=e,this.setProp(t.Constants.GameProperties.IsOpen,e))},o.prototype.setMaxPlayers=function(e){this.maxPlayers!=e&&(this.maxPlayers=e,this.setProp(t.Constants.GameProperties.MaxPlayers,e))},o.prototype.setEmptyRoomLiveTime=function(e){this.emptyRoomLiveTime=e},o.prototype.setSuspendedPlayerLiveTime=function(e){this.suspendedPlayerLiveTime=e},o.prototype.setPlugins=function(e){this.plugins=e},o.prototype.setUniqueUserId=function(e){this.uniqueUserId=e},o.prototype.setPropsListedInLobby=function(e){this._propsListedInLobby=e},o.prototype._setLBC=function(e){this.loadBalancingClient=e},o}(s);t.Room=i;var a=function(){function r(o,n,s){this.appId=n,this.appVersion=s,this.autoJoinLobby=!0,this.connectOptions={},this.createRoomOptions={},this.joinRoomOptions={},this.roomInfos=new Array,this.roomInfosDict={},this.actors={},this.actorsArray=[],this.lowestActorId=0,this.userAuthType=t.Constants.CustomAuthenticationType.None,this.userAuthParameters="",this.userAuthData="",this.lobbyStatsRequestList=new Array,this.state=r.State.Uninitialized,this.logger=new Exitgames.Common.Logger("Client:"),this.validNextState={};if("number"==typeof o)switch(this.connectionProtocol=o,o){case e.ConnectionProtocol.Ws:this.masterServerAddress="ws://app-eu.exitgamescloud.com:9090",this.nameServerAddress="ws://ns.exitgames.com:9093";break;case e.ConnectionProtocol.Wss:this.masterServerAddress="wss://app-eu.exitgamescloud.com:19090",this.nameServerAddress="wss://ns.exitgames.com:19093";break;default:var i="wrong_protocol_error";this.masterServerAddress=i,this.nameServerAddress=i,this.logger.error("Wrong protocol: ",o)}else if("string"==typeof o){this.connectionProtocol=e.ConnectionProtocol.Ws;var a=o;this.masterServerAddress=a,this.nameServerAddress=a}else{this.connectionProtocol=e.ConnectionProtocol.Ws;var p="wrong_protocol_type_error";this.masterServerAddress=p,this.nameServerAddress=p,this.logger.error("Wrong protocol type: ",typeof o)}this.initValidNextState(),this.currentRoom=this.roomFactoryInternal(""),this._myActor=this.actorFactoryInternal("",-1,!0),this.addActor(this._myActor)}return r.prototype.onStateChange=function(e){},r.prototype.onError=function(e,t){},r.prototype.onOperationResponse=function(e,t,o,r){},r.prototype.onEvent=function(e,t,o){},r.prototype.onRoomList=function(e){},r.prototype.onRoomListUpdate=function(e,t,o,r){},r.prototype.onMyRoomPropertiesChange=function(){},r.prototype.onActorPropertiesChange=function(e){},r.prototype.onJoinRoom=function(e){},r.prototype.onActorJoin=function(e){},r.prototype.onActorLeave=function(e,t){},r.prototype.onActorSuspend=function(e){},r.prototype.onFindFriendsResult=function(e,t,o){},r.prototype.onLobbyStats=function(e,t,o){},r.prototype.onAppStats=function(e,t,o){},r.prototype.onGetRegionsResult=function(e,t,o){},r.prototype.onWebRpcResult=function(e,t,o,r,n){},r.prototype.roomFactory=function(e){return new i(e)},r.prototype.actorFactory=function(e,t,o){return new n(e,t,o)},r.prototype.myActor=function(){return this._myActor},r.prototype.myRoom=function(){return this.currentRoom},r.prototype.myRoomActors=function(){return this.actors},r.prototype.myRoomActorCount=function(){return this.actorsArray.length},r.prototype.myRoomActorsArray=function(){return this.actorsArray},r.prototype.myRoomMasterActorNr=function(){return this.myRoom().masterClientId?this.myRoom().masterClientId:this.lowestActorId},r.prototype.lastRtt=function(){return this.gamePeer&&this.gamePeer.getLastRtt()},r.prototype.roomFactoryInternal=function(e){void 0===e&&(e="");var t=this.roomFactory(e);return t._setLBC(this),t},r.prototype.actorFactoryInternal=function(e,t,o){void 0===e&&(e=""),void 0===t&&(t=-1),void 0===o&&(o=!1);var r=this.actorFactory(e,t,o);return r._setLBC(this),r},r.prototype.setNameServerAddress=function(e){this.nameServerAddress=e},r.prototype.getNameServerAddress=function(){return this.nameServerAddress},r.prototype.setMasterServerAddress=function(e){this.masterServerAddress=e},r.prototype.getMasterServerAddress=function(){return this.nameServerAddress},r.prototype.setUserId=function(e){this.userId=e},r.prototype.getUserId=function(){return this.userId},r.prototype.setCustomAuthentication=function(t,o,r){void 0===o&&(o=e.LoadBalancing.Constants.CustomAuthenticationType.Custom),this.userAuthType=o,this.userAuthParameters=t,this.userAuthData=r},r.prototype.connect=function(e){if("boolean"==typeof e&&(e=e?{keepMasterConnection:!0}:{keepMasterConnection:!1}),e||(e={}),this.checkNextState(r.State.ConnectingToMasterserver,!0)){this.changeState(r.State.ConnectingToMasterserver),this.logger.info("Connecting to Master",this.masterServerAddress),this.connectOptions={};
for(var t in e)this.connectOptions[t]=e[t];return this.masterPeer=new c(this,o(this.masterServerAddress,this.connectionProtocol),""),this.initMasterPeer(this.masterPeer),this.masterPeer.connect(),!0}return!1},r.prototype.connectToNameServer=function(e){if(e||(e={}),this.checkNextState(r.State.ConnectingToNameServer,!0)){this.changeState(r.State.ConnectingToNameServer),this.logger.info("Connecting to NameServer",this.nameServerAddress),this.connectOptions={};for(var t in e)this.connectOptions[t]=e[t];return this.nameServerPeer=new d(this,o(this.nameServerAddress,this.connectionProtocol),""),this.initNameServerPeer(this.nameServerPeer),this.nameServerPeer.connect(),!0}return!1},r.prototype.fillCreateRoomOptions=function(e,o){o=o||{};var r={};if(void 0!==o.isVisible&&(r[t.Constants.GameProperties.IsVisible]=o.isVisible),void 0!==o.isOpen&&(r[t.Constants.GameProperties.IsOpen]=o.isOpen),void 0!==o.maxPlayers&&(r[t.Constants.GameProperties.MaxPlayers]=o.maxPlayers),void 0!==o.propsListedInLobby&&(r[t.Constants.GameProperties.PropsListedInLobby]=o.propsListedInLobby),void 0!==o.customGameProperties)for(var n in o.customGameProperties)r[n]=o.customGameProperties[n];e.push(t.Constants.ParameterCode.GameProperties,r),e.push(t.Constants.ParameterCode.CleanupCacheOnLeave,!0),e.push(t.Constants.ParameterCode.Broadcast,!0),void 0!==o.emptyRoomLiveTime&&e.push(t.Constants.ParameterCode.EmptyRoomTTL,o.emptyRoomLiveTime),void 0!==o.suspendedPlayerLiveTime&&e.push(t.Constants.ParameterCode.PlayerTTL,o.suspendedPlayerLiveTime),void 0!==o.plugins&&e.push(t.Constants.ParameterCode.Plugins,o.plugins),void 0!==o.uniqueUserId&&e.push(t.Constants.ParameterCode.CheckUserOnJoin,o.uniqueUserId),o.lobbyName&&(e.push(t.Constants.ParameterCode.LobbyName),e.push(o.lobbyName),void 0!=o.lobbyType&&(e.push(t.Constants.ParameterCode.LobbyType),e.push(o.lobbyType)))},r.prototype.createRoomFromMy=function(e,t){return this.currentRoom.name=e?e:"",t=this.copyCreateOptionsFromMyRoom(t),this.createRoomInternal(this.masterPeer,t)},r.prototype.copyCreateOptionsFromMyRoom=function(e){return e=e||{},e.isVisible=this.currentRoom.isVisible,e.isOpen=this.currentRoom.isOpen,e.maxPlayers=this.currentRoom.maxPlayers,e.customGameProperties=this.currentRoom._customProperties,e.propsListedInLobby=this.currentRoom._propsListedInLobby,e.emptyRoomLiveTime=this.currentRoom.emptyRoomLiveTime,e.suspendedPlayerLiveTime=this.currentRoom.suspendedPlayerLiveTime,e.plugins=this.currentRoom.plugins,e.uniqueUserId=this.currentRoom.uniqueUserId,e},r.prototype.createRoom=function(e,t){return this.currentRoom=this.roomFactoryInternal(e?e:""),this.createRoomInternal(this.masterPeer,t)},r.prototype.joinRoom=function(e,o,n){var s=[];return o&&(o.createIfNotExists&&(s.push(t.Constants.ParameterCode.JoinMode,r.JoinMode.CreateIfNotExists),this.fillCreateRoomOptions(s,n)),o.joinToken&&(s.push(t.Constants.ParameterCode.ActorNr,parseInt(o.joinToken)),s.push(t.Constants.ParameterCode.JoinMode,r.JoinMode.Rejoin))),this.currentRoom=this.roomFactoryInternal(e),s.push(t.Constants.ParameterCode.RoomName,e),this.joinRoomOptions=o||{},this.createRoomOptions=n||{},this.logger.info("Join Room",e,o,n,"..."),this.masterPeer.sendOperation(t.Constants.OperationCode.JoinGame,s),!0},r.prototype.joinRandomRoom=function(e){var o=[];if(e){void 0!=e.matchingType&&e.matchingType!=t.Constants.MatchmakingMode.FillRoom&&(o.push(t.Constants.ParameterCode.MatchMakingType),o.push(e.matchingType));var r={},n=!1;if(void 0!=e.expectedCustomRoomProperties)for(var s in e.expectedCustomRoomProperties)r[s]=e.expectedCustomRoomProperties[s],n=!0;void 0!=e.expectedMaxPlayers&&e.expectedMaxPlayers>0&&(r[t.Constants.GameProperties.MaxPlayers]=e.expectedMaxPlayers,n=!0),n&&(o.push(t.Constants.ParameterCode.GameProperties),o.push(r)),e.lobbyName&&(o.push(t.Constants.ParameterCode.LobbyName),o.push(e.lobbyName),void 0!=e.lobbyType&&(o.push(t.Constants.ParameterCode.LobbyType),o.push(e.lobbyType))),e.sqlLobbyFilter&&(o.push(t.Constants.ParameterCode.Data),o.push(e.sqlLobbyFilter))}return this.logger.info("Join Random Room",e&&e.lobbyName,e&&e.lobbyType,"..."),this.masterPeer.sendOperation(t.Constants.OperationCode.JoinRandomGame,o),!0},r.prototype._setPropertiesOfRoom=function(e,o,r){var n=[];n.push(t.Constants.ParameterCode.Properties),n.push(e),n.push(t.Constants.ParameterCode.Broadcast),n.push(!0),o&&(n.push(t.Constants.ParameterCode.Forward),n.push(!0)),r&&(n.push(t.Constants.ParameterCode.ExpectedValues),n.push(r)),this.gamePeer.sendOperation(t.Constants.OperationCode.SetProperties,n)},r.prototype._setPropertiesOfActor=function(e,o,r,n){var s=[];s.push(t.Constants.ParameterCode.ActorNr),s.push(e),s.push(t.Constants.ParameterCode.Properties),s.push(o),s.push(t.Constants.ParameterCode.Broadcast),s.push(!0),r&&(s.push(t.Constants.ParameterCode.Forward),s.push(!0)),n&&(s.push(t.Constants.ParameterCode.ExpectedValues),s.push(n)),this.gamePeer.sendOperation(t.Constants.OperationCode.SetProperties,s)},r.prototype.disconnect=function(){this.nameServerPeer&&this.nameServerPeer.disconnect(),this._cleanupNameServerPeerData(),this.masterPeer&&this.masterPeer.disconnect(),this._cleanupMasterPeerData(),this.gamePeer&&this.gamePeer.disconnect(),this._cleanupGamePeerData(),this.changeState(r.State.Disconnected)},r.prototype.suspendRoom=function(){this.isJoinedToRoom()&&(this.gamePeer&&this.gamePeer.disconnect(),this._cleanupGamePeerData(),this.isConnectedToMaster()?this.changeState(r.State.JoinedLobby):(this.changeState(r.State.Disconnected),this.connect(this.connectOptions)))},r.prototype.leaveRoom=function(){this.isJoinedToRoom()&&(this.gamePeer&&(this.gamePeer.sendOperation(t.Constants.OperationCode.Leave),this.gamePeerWaitingForDisconnect=!0),this._cleanupGamePeerData(),this.isConnectedToMaster()?this.changeState(r.State.JoinedLobby):(this.changeState(r.State.Disconnected),this.connect(this.connectOptions)))},r.prototype.raiseEvent=function(e,t,o){this.isJoinedToRoom()&&this.gamePeer.raiseEvent(e,t,o)},r.prototype.changeGroups=function(e,t){this.isJoinedToRoom()&&(this.logger.debug("Group change:",e,t),this.gamePeer.changeGroups(e,t))},r.prototype.findFriends=function(e){if(this.isConnectedToMaster())if(e&&"object"==typeof e){this.findFriendsRequestList=new Array;for(var t=0;t<e.length;++t){if("string"!=typeof e[t])return this.logger.error("FindFriends request error:","Friend name is not a string",t),void this.onFindFriendsResult(1101,"Friend name is not a string "+t,{});this.findFriendsRequestList[t]=e[t]}this.logger.debug("Find friends:",e),this.masterPeer.findFriends(this.findFriendsRequestList)}else this.logger.error("FindFriends request error:","Parameter is not an array"),this.onFindFriendsResult(1101,"Parameter is not an array",{});else this.logger.error("FindFriends request error:","Not connected to Master"),this.onFindFriendsResult(1001,"Not connected to Master",{})},r.prototype.requestLobbyStats=function(e){if(this.isConnectedToMaster()){if(this.lobbyStatsRequestList=new Array,e){if("object"!=typeof e)return void this.requestLobbyStatsErr("Parameter is not an array");for(var o=0;o<e.length;++o){var r=e[o];if("object"!=typeof r)return void this.requestLobbyStatsErr("Lobby id is not an array",o);var n=r[0];if(!n)return void this.requestLobbyStatsErr("Lobby name is empty",o);var s;if(void 0===r[1])s=t.Constants.LobbyType.Default;else{if("number"!=typeof r[1])return void this.requestLobbyStatsErr("Lobby type is invalid",o);s=r[1]}this.lobbyStatsRequestList[o]=[n.toString(),s]}}this.masterPeer.requestLobbyStats(this.lobbyStatsRequestList)}else this.logger.error("LobbyState request error:","Not connected to Master"),this.onLobbyStats(1001,"Not connected to Master",[])},r.prototype.requestLobbyStatsErr=function(e,t){void 0===t&&(t=""),this.logger.error("LobbyState request error:",e,t),this.onLobbyStats(1101,e+" "+t,[])},r.prototype.getRegions=function(){this.isConnectedToNameServer()?(this.logger.debug("GetRegions..."),this.nameServerPeer.getRegions(this.appId)):(this.logger.error("GetRegions request error:","Not connected to NameServer"),this.onGetRegionsResult(3001,"Not connected to NameServer",{}))},r.prototype.webRpc=function(e,t){this.isConnectedToMaster()?(this.logger.debug("WebRpc..."),this.masterPeer.webRpc(e,t)):this.isJoinedToRoom()?(this.logger.debug("WebRpc..."),this.gamePeer.webRpc(e,t)):(this.logger.error("WebRpc request error:","Connected to neither Master nor Game server"),this.onWebRpcResult(1001,"Connected to neither Master nor Game server",e,0,{}))},r.prototype.connectToRegionMaster=function(e){return this.isConnectedToNameServer()?(this.logger.debug("Connecting to Region Master",e,"..."),this.nameServerPeer.opAuth(this.appId,this.appVersion,this.userAuthType,this.userAuthParameters,this.userAuthData,this.userId,e),!0):this.connectToNameServer({region:e})?!0:(this.logger.error("Connecting to Region Master error:","Not connected to NameServer"),!1)},r.prototype.isConnectedToMaster=function(){return this.masterPeer&&this.masterPeer.isConnected()},r.prototype.isConnectedToNameServer=function(){return this.nameServerPeer&&this.nameServerPeer.isConnected()},r.prototype.isInLobby=function(){return this.state==r.State.JoinedLobby},r.prototype.isJoinedToRoom=function(){return this.state==r.State.Joined},r.prototype.isConnectedToGame=function(){return this.isJoinedToRoom()},r.prototype.availableRooms=function(){return this.roomInfos},r.prototype.setLogLevel=function(e){this.logger.setLevel(e),this.nameServerPeer&&this.nameServerPeer.setLogLevel(e),this.masterPeer&&this.masterPeer.setLogLevel(e),this.gamePeer&&this.gamePeer.setLogLevel(e)},r.prototype.addRoom=function(e){this.roomInfos.push(e),this.roomInfosDict[e.name]=e},r.prototype.clearRooms=function(){this.roomInfos=new Array,this.roomInfosDict={}},r.prototype.purgeRemovedRooms=function(){this.roomInfos=this.roomInfos.filter(function(e){return!e.removed});for(var e in this.roomInfosDict)this.roomInfosDict[e].removed&&delete this.roomInfosDict[e]},r.prototype.addActor=function(e){this.actors[e.actorNr]=e,this.actorsArray.push(e),this.currentRoom.playerCount=this.actorsArray.length,(0==this.lowestActorId||this.lowestActorId>e.actorNr)&&(this.lowestActorId=e.actorNr)},r.prototype.removeActor=function(e){delete this.actors[e],this.actorsArray=this.actorsArray.filter(function(t){return t.actorNr!=e}),this.currentRoom.playerCount=this.actorsArray.length,this.lowestActorId==e&&(this.actorsArray.length>0?this.lowestActorId=this.actorsArray.reduce(function(e,t){return e.actorNr<t.actorNr?e:t}).actorNr:this.lowestActorId=0)},r.prototype.clearActors=function(){this.actors={},this.actorsArray=[],this.currentRoom.playerCount=0,this.lowestActorId=0},r.prototype.changeState=function(e){this.logger.info("State:",r.StateToName(this.state),"->",r.StateToName(e)),this.state=e,this.onStateChange(e)},r.prototype.createRoomInternal=function(e,o){var r=[];this.currentRoom.name&&r.push(t.Constants.ParameterCode.RoomName,this.currentRoom.name),this.fillCreateRoomOptions(r,o),e===this.masterPeer&&(this.createRoomOptions=o),e===this.gamePeer&&(r.push(t.Constants.ParameterCode.PlayerProperties),r.push(this._myActor._getAllProperties()));var n=e==this.gamePeer?this.gamePeer._logger:this.masterPeer._logger;n.info("Create Room",o&&o.lobbyName,o&&o.lobbyType,"..."),e.sendOperation(t.Constants.OperationCode.CreateGame,r)},r.prototype.updateUserIdAndNickname=function(e,o){var r=e[t.Constants.ParameterCode.UserId];void 0!=r&&(this.setUserId(r),o.info("Setting userId sent by server:",r));var n=e[t.Constants.ParameterCode.Nickname];void 0!=n&&(this.myActor().setName(n),o.info("Setting nickname sent by server:",n))},r.prototype.initNameServerPeer=function(o){var n=this;o.setLogLevel(this.logger.getLevel()),o.addPeerStatusListener(e.PhotonPeer.StatusCodes.error,function(){n.changeState(r.State.Error),n._onErrorInternal(r.PeerErrorCode.NameServerError,"NameServer peer error")}),o.addPeerStatusListener(e.PhotonPeer.StatusCodes.connectFailed,function(){n.changeState(r.State.Error),n._onErrorInternal(r.PeerErrorCode.NameServerConnectFailed,"NameServer peer connect failed. "+n.nameServerAddress)}),o.addPeerStatusListener(e.PhotonPeer.StatusCodes.timeout,function(){n.changeState(r.State.Error),n._onErrorInternal(r.PeerErrorCode.NameServerTimeout,"NameServer peer timeout")}),o.addPeerStatusListener(e.PhotonPeer.StatusCodes.connecting,function(){}),o.addPeerStatusListener(e.PhotonPeer.StatusCodes.connect,function(){o._logger.info("Connected"),n.changeState(r.State.ConnectedToNameServer),void 0!=n.connectOptions.region&&o.opAuth(n.appId,n.appVersion,n.userAuthType,n.userAuthParameters,n.userAuthData,n.userId,n.connectOptions.region)}),o.addPeerStatusListener(e.PhotonPeer.StatusCodes.disconnect,function(){o==n.nameServerPeer&&(n._cleanupNameServerPeerData(),o._logger.info("Disconnected"))}),o.addPeerStatusListener(e.PhotonPeer.StatusCodes.connectClosed,function(){o._logger.info("Server closed connection"),n.changeState(r.State.Error),n._onErrorInternal(r.PeerErrorCode.NameServerConnectClosed,"NameServer server closed connection")}),o.addResponseListener(t.Constants.OperationCode.GetRegions,function(e){o._logger.debug("resp GetRegions",e);var r={};if(0==e.errCode){var s=e.vals[t.Constants.ParameterCode.Region],i=e.vals[t.Constants.ParameterCode.Address];for(var a in s)r[s[a]]=i[a]}else o._logger.error("GetRegions request error.",e.errCode);n.onGetRegionsResult(e.errCode,e.errMsg,r)}),o.addResponseListener(t.Constants.OperationCode.Authenticate,function(e){o._logger.debug("resp Authenticate",e),0==e.errCode?(o._logger.info("Authenticated"),o.disconnect(),n.updateUserIdAndNickname(e.vals,o._logger),n.masterServerAddress=e.vals[t.Constants.ParameterCode.Address],o._logger.info("Connecting to Master server",n.masterServerAddress,"..."),n.connect({userAuthSecret:e.vals[t.Constants.ParameterCode.Secret]})):(n.changeState(r.State.Error),n._onErrorInternal(r.PeerErrorCode.NameServerAuthenticationFailed,"NameServer authentication failed"))})},r.prototype.initMasterPeer=function(o){var n=this;o.setLogLevel(this.logger.getLevel()),o.addPeerStatusListener(e.PhotonPeer.StatusCodes.error,function(){n.changeState(r.State.Error),n._onErrorInternal(r.PeerErrorCode.MasterError,"Master peer error")}),o.addPeerStatusListener(e.PhotonPeer.StatusCodes.connectFailed,function(){n.changeState(r.State.Error),n._onErrorInternal(r.PeerErrorCode.MasterConnectFailed,"Master peer connect failed: "+n.masterServerAddress)}),o.addPeerStatusListener(e.PhotonPeer.StatusCodes.timeout,function(){n.changeState(r.State.Error),n._onErrorInternal(r.PeerErrorCode.MasterTimeout,"Master peer error timeout")}),o.addPeerStatusListener(e.PhotonPeer.StatusCodes.connecting,function(){}),o.addPeerStatusListener(e.PhotonPeer.StatusCodes.connect,function(){o._logger.info("Connected");var e=[];n.connectOptions.userAuthSecret?(e.push(t.Constants.ParameterCode.Secret,n.connectOptions.userAuthSecret),o.sendOperation(t.Constants.OperationCode.Authenticate,e),o._logger.info("Authenticate with secret...")):(e.push(t.Constants.ParameterCode.ApplicationId),e.push(n.appId),e.push(t.Constants.ParameterCode.AppVersion),e.push(n.appVersion),n.userAuthType!=t.Constants.CustomAuthenticationType.None&&(e.push(t.Constants.ParameterCode.ClientAuthenticationType,n.userAuthType),e.push(t.Constants.ParameterCode.ClientAuthenticationParams,n.userAuthParameters),n.userAuthData&&e.push(t.Constants.ParameterCode.ClientAuthenticationData,n.userAuthData)),n.userId&&e.push(t.Constants.ParameterCode.UserId,n.userId),n.connectOptions.lobbyStats&&e.push(t.Constants.ParameterCode.LobbyStats,!0),o.sendOperation(t.Constants.OperationCode.Authenticate,e),o._logger.info("Authenticate..."))}),o.addPeerStatusListener(e.PhotonPeer.StatusCodes.disconnect,function(){o==n.masterPeer&&(n._cleanupMasterPeerData(),o._logger.info("Disconnected"))}),o.addPeerStatusListener(e.PhotonPeer.StatusCodes.connectClosed,function(){o._logger.info("Server closed connection"),n.changeState(r.State.Error),n._onErrorInternal(r.PeerErrorCode.MasterConnectClosed,"Master server closed connection")}),o.addEventListener(t.Constants.EventCode.GameList,function(e){var r=e.vals[t.Constants.ParameterCode.GameList];n.clearRooms();for(var i in r){var a=new s(i);a._updateFromProps(r[i]),n.addRoom(a)}n.onRoomList(n.roomInfos),o._logger.debug("ev GameList",n.roomInfos,r)}),o.addEventListener(t.Constants.EventCode.GameListUpdate,function(e){var r=e.vals[t.Constants.ParameterCode.GameList],i=new Array,a=new Array,p=new Array;for(var d in r){var c=n.roomInfos.filter(function(e){return e.name==d});if(c.length>0){var u=c[0];u._updateFromProps(r[d]),u.removed?p.push(u):i.push(u)}else{var h=new s(d);h._updateFromProps(r[d]),n.addRoom(h),a.push(u)}}n.purgeRemovedRooms(),n.onRoomListUpdate(n.roomInfos,i,a,p),o._logger.debug("ev GameListUpdate:",n.roomInfos,"u:",i,"a:",a,"r:",p,r)}),o.addResponseListener(t.Constants.OperationCode.Authenticate,function(e){if(o._logger.debug("resp Authenticate",e),e.errCode)n.changeState(r.State.Error),n._onErrorInternal(r.PeerErrorCode.MasterAuthenticationFailed,"Master authentication failed");else{o._logger.info("Authenticated"),n.updateUserIdAndNickname(e.vals,o._logger),void 0!=e.vals[t.Constants.ParameterCode.Secret]&&(n.connectOptions.userAuthSecret=e.vals[t.Constants.ParameterCode.Secret]),n.changeState(r.State.ConnectedToMaster);var s=[];n.connectOptions.lobbyName&&(s.push(t.Constants.ParameterCode.LobbyName),s.push(n.connectOptions.lobbyName),void 0!=n.connectOptions.lobbyType&&(s.push(t.Constants.ParameterCode.LobbyType),s.push(n.connectOptions.lobbyType))),n.autoJoinLobby&&(o.sendOperation(t.Constants.OperationCode.JoinLobby,s),o._logger.info("Join Lobby",n.connectOptions.lobbyName,n.connectOptions.lobbyType,"..."))}}),o.addResponseListener(t.Constants.OperationCode.JoinLobby,function(e){o._logger.debug("resp JoinLobby",e),e.errCode||(o._logger.info("Joined to Lobby"),n.changeState(r.State.JoinedLobby)),n._onOperationResponseInternal2(t.Constants.OperationCode.JoinLobby,e)}),o.addResponseListener(t.Constants.OperationCode.CreateGame,function(e){o._logger.debug("resp CreateGame",e),e.errCode||(n.currentRoom._updateFromMasterResponse(e.vals),o._logger.debug("Created/Joined "+n.currentRoom.name),n.connectToGameServer(t.Constants.OperationCode.CreateGame)),n._onOperationResponseInternal2(t.Constants.OperationCode.CreateGame,e)}),o.addResponseListener(t.Constants.OperationCode.JoinGame,function(e){o._logger.debug("resp JoinGame",e),e.errCode||(n.currentRoom._updateFromMasterResponse(e.vals),o._logger.debug("Joined "+n.currentRoom.name),n.connectToGameServer(t.Constants.OperationCode.JoinGame)),n._onOperationResponseInternal2(t.Constants.OperationCode.JoinGame,e)}),o.addResponseListener(t.Constants.OperationCode.JoinRandomGame,function(e){o._logger.debug("resp JoinRandomGame",e),e.errCode||(n.currentRoom._updateFromMasterResponse(e.vals),o._logger.debug("Joined "+n.currentRoom.name),n.connectToGameServer(t.Constants.OperationCode.JoinRandomGame)),n._onOperationResponseInternal2(t.Constants.OperationCode.JoinRandomGame,e)}),o.addResponseListener(t.Constants.OperationCode.FindFriends,function(e){o._logger.debug("resp FindFriends",e);var r={};if(e.errCode)o._logger.error("FindFriends request error:",e.errCode);else for(var s=e.vals[t.Constants.ParameterCode.FindFriendsResponseOnlineList]||{},i=e.vals[t.Constants.ParameterCode.FindFriendsResponseRoomIdList]||{},a=0;a<n.findFriendsRequestList.length;++a){var p=n.findFriendsRequestList[a];p&&(r[p]={online:s[a],roomId:i[a]})}n.onFindFriendsResult(e.errCode,e.errMsg,r)}),o.addResponseListener(t.Constants.OperationCode.LobbyStats,function(e){o._logger.debug("resp LobbyStats",e);var r=new Array;if(e.errCode)o._logger.error("LobbyStats request error:",e.errCode);else{var s=e.vals[t.Constants.ParameterCode.LobbyName],i=e.vals[t.Constants.ParameterCode.LobbyType]||{},a=e.vals[t.Constants.ParameterCode.PeerCount]||{},p=e.vals[t.Constants.ParameterCode.GameCount]||{};if(s)for(var d=0;d<s.length;++d)r[d]={lobbyName:s[d],lobbyType:i[d],peerCount:a[d],gameCount:p[d]};else for(var d=0;d<n.lobbyStatsRequestList.length;++d){var c=n.lobbyStatsRequestList[d];r[d]={lobbyName:c[0],lobbyType:c[1],peerCount:a[d],gameCount:p[d]}}}n.onLobbyStats(e.errCode,e.errMsg,r)}),o.addEventListener(t.Constants.EventCode.LobbyStats,function(e){o._logger.debug("ev LobbyStats",e);var r=new Array,s=e.vals[t.Constants.ParameterCode.LobbyName],i=e.vals[t.Constants.ParameterCode.LobbyType]||{},a=e.vals[t.Constants.ParameterCode.PeerCount]||{},p=e.vals[t.Constants.ParameterCode.GameCount]||{};if(s)for(var d=0;d<s.length;++d)r[d]={lobbyName:s[d],lobbyType:i[d],peerCount:a[d],gameCount:p[d]};n.onLobbyStats(0,"",r)}),o.addEventListener(t.Constants.EventCode.AppStats,function(e){o._logger.debug("ev AppStats",e);var r={peerCount:e.vals[t.Constants.ParameterCode.PeerCount],masterPeerCount:e.vals[t.Constants.ParameterCode.MasterPeerCount],gameCount:e.vals[t.Constants.ParameterCode.GameCount]};n.onAppStats(0,"",r)}),o.addResponseListener(t.Constants.OperationCode.Rpc,o.webRpcHandler(this))},r.prototype.connectToGameServer=function(e){return this.connectOptions.keepMasterConnection||this.masterPeer.disconnect(),this.checkNextState(r.State.ConnectingToGameserver,!0)?(this.logger.info("Connecting to Game",this.currentRoom.address),this.gamePeer=new u(this,o(this.currentRoom.address,this.connectionProtocol),""),this.gamePeerWaitingForDisconnect=!1,this.initGamePeer(this.gamePeer,e),this.gamePeer.connect(),this.changeState(r.State.ConnectingToGameserver),!0):!1},r.prototype.initGamePeer=function(o,s){var i=this;o.setLogLevel(this.logger.getLevel()),o.addPeerStatusListener(e.PhotonPeer.StatusCodes.error,function(){i.changeState(r.State.Error),i._onErrorInternal(r.PeerErrorCode.GameError,"Game peer error")}),o.addPeerStatusListener(e.PhotonPeer.StatusCodes.connectFailed,function(){i.changeState(r.State.Error),i._onErrorInternal(r.PeerErrorCode.GameConnectFailed,"Game peer connect failed: "+i.currentRoom.address)}),o.addPeerStatusListener(e.PhotonPeer.StatusCodes.timeout,function(){i.changeState(r.State.Error),i._onErrorInternal(r.PeerErrorCode.GameTimeout,"Game peer timeout")}),o.addPeerStatusListener(e.PhotonPeer.StatusCodes.connect,function(){o._logger.info("Connected");var e=[];e.push(t.Constants.ParameterCode.ApplicationId),e.push(i.appId),e.push(t.Constants.ParameterCode.AppVersion),e.push(i.appVersion),void 0!=i.connectOptions.userAuthSecret&&(e.push(t.Constants.ParameterCode.Secret),e.push(i.connectOptions.userAuthSecret)),i.userAuthType!=t.Constants.CustomAuthenticationType.None&&(e.push(t.Constants.ParameterCode.ClientAuthenticationType),e.push(i.userAuthType)),i.userId&&e.push(t.Constants.ParameterCode.UserId,i.userId),o.sendOperation(t.Constants.OperationCode.Authenticate,e),o._logger.info("Authenticate...")}),o.addPeerStatusListener(e.PhotonPeer.StatusCodes.disconnect,function(){o==i.gamePeer&&(i._cleanupGamePeerData(),o._logger.info("Disconnected"))}),o.addPeerStatusListener(e.PhotonPeer.StatusCodes.connectClosed,function(){o._logger.info("Server closed connection"),i.gamePeerWaitingForDisconnect||(i.changeState(r.State.Error),i._onErrorInternal(r.PeerErrorCode.MasterConnectClosed,"Game server closed connection"))}),o.addResponseListener(t.Constants.OperationCode.Authenticate,function(e){if(o._logger.debug("resp Authenticate",e),e.errCode)i.changeState(r.State.Error),i._onErrorInternal(r.PeerErrorCode.GameAuthenticationFailed,"Game authentication failed");else{if(o._logger.info("Authenticated"),o._logger.info("Connected"),s==t.Constants.OperationCode.CreateGame)i.createRoomInternal(o,i.createRoomOptions);else{var n=[];n.push(t.Constants.ParameterCode.RoomName),n.push(i.currentRoom.name),n.push(t.Constants.ParameterCode.Broadcast),n.push(!0),n.push(t.Constants.ParameterCode.PlayerProperties),n.push(i._myActor._getAllProperties()),s==t.Constants.OperationCode.JoinGame&&(i.joinRoomOptions.createIfNotExists&&(n.push(t.Constants.ParameterCode.JoinMode,r.JoinMode.CreateIfNotExists),i.fillCreateRoomOptions(n,i.createRoomOptions)),i.joinRoomOptions.joinToken&&(n.push(t.Constants.ParameterCode.ActorNr,parseInt(i.joinRoomOptions.joinToken)),n.push(t.Constants.ParameterCode.JoinMode,r.JoinMode.Rejoin))),o.sendOperation(t.Constants.OperationCode.JoinGame,n)}i.changeState(r.State.ConnectedToGameserver)}}),o.addResponseListener(t.Constants.OperationCode.CreateGame,function(e){o._logger.debug("resp CreateGame",e),e.errCode||(i._myActor._updateMyActorFromResponse(e.vals),o._logger.info("myActor: ",i._myActor),i.currentRoom._updateFromProps(e.vals[t.Constants.ParameterCode.GameProperties]),i.clearActors(),i.addActor(i._myActor),i.changeState(r.State.Joined),i.onJoinRoom(!0)),i._onOperationResponseInternal2(t.Constants.OperationCode.CreateGame,e)}),o.addResponseListener(t.Constants.OperationCode.JoinGame,function(e){if(o._logger.debug("resp JoinGame",e),!e.errCode){i._myActor._updateMyActorFromResponse(e.vals),o._logger.info("myActor: ",i._myActor),i.clearActors(),i.addActor(i._myActor);var n=e.vals[t.Constants.ParameterCode.ActorList],s=e.vals[t.Constants.ParameterCode.PlayerProperties];if(void 0!==n)for(var a in n){var p,d=n[a];void 0!==s&&(p=s[d]);var c;void 0!==p&&(c=p[t.Constants.ActorProperties.PlayerName]);var u;d==i._myActor.actorNr?u=i._myActor:(u=i.actorFactoryInternal(c,d),i.addActor(u)),void 0!==p&&u._updateCustomProperties(p)}i.currentRoom._updateFromProps(e.vals[t.Constants.ParameterCode.GameProperties]),i.changeState(r.State.Joined),i.onJoinRoom(!1)}i._onOperationResponseInternal2(t.Constants.OperationCode.JoinGame,e)}),o.addResponseListener(t.Constants.OperationCode.SetProperties,function(e){o._logger.debug("resp SetProperties",e),i._onOperationResponseInternal2(t.Constants.OperationCode.SetProperties,e)}),o.addResponseListener(t.Constants.OperationCode.Leave,function(e){o._logger.debug("resp Leave",e),o.disconnect(),i._onOperationResponseInternal2(t.Constants.OperationCode.Leave,e)}),o.addResponseListener(t.Constants.OperationCode.Rpc,o.webRpcHandler(this)),o.addEventListener(t.Constants.EventCode.Join,function(e){if(o._logger.debug("ev Join",e),n._getActorNrFromResponse(e.vals)===i._myActor.actorNr)i._myActor._updateFromResponse(e.vals),i.onActorJoin(i._myActor);else{var t=i.actorFactoryInternal();t._updateFromResponse(e.vals),i.addActor(t),i.onActorJoin(t)}}),o.addEventListener(t.Constants.EventCode.Leave,function(e){o._logger.debug("ev Leave",e),i.myRoom()._updateFromEvent(e.vals);var r=n._getActorNrFromResponse(e.vals);if(r&&i.actors[r]){var s=i.actors[r];e.vals[t.Constants.ParameterCode.IsInactive]?(s._setSuspended(!0),i.onActorSuspend(s)):(i.removeActor(r),i.onActorLeave(s,!1))}}),o.addEventListener(t.Constants.EventCode.Disconnect,function(e){o._logger.debug("ev Disconnect",e);var t=n._getActorNrFromResponse(e.vals);if(t&&i.actors[t]){var r=i.actors[t];r._setSuspended(!0),i.onActorSuspend(r)}}),o.addEventListener(t.Constants.EventCode.PropertiesChanged,function(e){o._logger.debug("ev PropertiesChanged",e);var r=e.vals[t.Constants.ParameterCode.TargetActorNr];if(void 0!==r&&r>0){if(void 0!==i.actors[r]){var n=i.actors[r];n._updateCustomProperties(e.vals[t.Constants.ParameterCode.Properties]),i.onActorPropertiesChange(n)}}else i.currentRoom._updateFromProps(e.vals[t.Constants.ParameterCode.Properties]),i.onMyRoomPropertiesChange()})},r.prototype._cleanupNameServerPeerData=function(){},r.prototype._cleanupMasterPeerData=function(){},r.prototype._cleanupGamePeerData=function(){for(var e in this.actors)this.onActorLeave(this.actors[e],!0);this.clearActors(),this.addActor(this._myActor)},r.prototype._onOperationResponseInternal2=function(e,t){t.errCode&&this.logger.warn("Operation",e,"error:",t.errMsg,"("+t.errCode+")"),this.onOperationResponse(t.errCode,t.errMsg,e,t.vals)},r.prototype._onErrorInternal=function(e,t){this.logger.error("Error:",e,t),this.onError(e,t)},r.prototype.initValidNextState=function(){this.validNextState[r.State.Error]=[r.State.ConnectingToMasterserver,r.State.ConnectingToNameServer],this.validNextState[r.State.Uninitialized]=[r.State.ConnectingToMasterserver,r.State.ConnectingToNameServer],this.validNextState[r.State.ConnectedToNameServer]=[r.State.ConnectingToMasterserver],this.validNextState[r.State.Disconnected]=[r.State.ConnectingToMasterserver,r.State.ConnectingToNameServer],this.validNextState[r.State.ConnectedToMaster]=[r.State.JoinedLobby],this.validNextState[r.State.JoinedLobby]=[r.State.ConnectingToGameserver],this.validNextState[r.State.ConnectingToGameserver]=[r.State.ConnectedToGameserver],this.validNextState[r.State.ConnectedToGameserver]=[r.State.Joined]},r.prototype.checkNextState=function(e,t){void 0===t&&(t=!1);var o=this.validNextState[this.state],n=o&&o.indexOf(e)>=0;if(!n){if(!t)throw new Error("LoadBalancingPeer checkNextState fail: "+r.StateToName(this.state)+" -> "+r.StateToName(e));this.logger.error("LoadBalancingPeer checkNextState fail: "+r.StateToName(this.state)+" -> "+r.StateToName(e))}return n},r.StateToName=function(e){return Exitgames.Common.Util.getEnumKeyByValue(r.State,e)},r.JoinMode={Default:0,CreateIfNotExists:1,Rejoin:2},r.PeerErrorCode={Ok:0,MasterError:1001,MasterConnectFailed:1002,MasterConnectClosed:1003,MasterTimeout:1004,MasterEncryptionEstablishError:1005,MasterAuthenticationFailed:1101,GameError:2001,GameConnectFailed:2002,GameConnectClosed:2003,GameTimeout:2004,GameEncryptionEstablishError:2005,GameAuthenticationFailed:2101,NameServerError:3001,NameServerConnectFailed:3002,NameServerConnectClosed:3003,NameServerTimeout:3004,NameServerEncryptionEstablishError:300,NameServerAuthenticationFailed:3101},r.State={Error:-1,Uninitialized:0,ConnectingToNameServer:1,ConnectedToNameServer:2,ConnectingToMasterserver:3,ConnectedToMaster:4,JoinedLobby:5,ConnectingToGameserver:6,ConnectedToGameserver:7,Joined:8,Disconnected:10},r}();t.LoadBalancingClient=a;var p=function(e){function o(){e.apply(this,arguments)}return __extends(o,e),o.prototype.webRpc=function(e,o){var r=[];r.push(t.Constants.ParameterCode.UriPath,e),r.push(t.Constants.ParameterCode.RpcCallParams,o),this.sendOperation(t.Constants.OperationCode.Rpc,r)},o.prototype.webRpcHandler=function(e){var o=this;return function(r){o._logger.debug("resp Rpc",r);var n,s,i;0==r.errCode?(n=r.vals[t.Constants.ParameterCode.UriPath],s=r.vals[t.Constants.ParameterCode.RpcCallRetData],i=r.vals[t.Constants.ParameterCode.RpcCallRetCode]):o._logger.error("WebRpc request error:",r.errCode),e.onWebRpcResult(r.errCode,r.errMsg,n,i,s)}},o}(e.PhotonPeer);t.LbcPeer=p;var d=function(e){function o(t,o,r){e.call(this,o,r,"NameServer"),this.client=t}return __extends(o,e),o.prototype.onUnhandledEvent=function(e,o){this.client.onEvent(e,o.vals[t.Constants.ParameterCode.CustomEventContent],o.vals[t.Constants.ParameterCode.ActorNr])},o.prototype.onUnhandledResponse=function(e,t){this.client.onOperationResponse(t.errCode,t.errMsg,e,t.vals)},o.prototype.getRegions=function(e){var o=[];o.push(t.Constants.ParameterCode.ApplicationId,e),this.sendOperation(t.Constants.OperationCode.GetRegions,o,!0,0)},o.prototype.opAuth=function(e,o,r,n,s,i,a){var p=[];p.push(t.Constants.ParameterCode.ApplicationId,e),p.push(t.Constants.ParameterCode.AppVersion,o),r!=t.Constants.CustomAuthenticationType.None&&(p.push(t.Constants.ParameterCode.ClientAuthenticationType,r),p.push(t.Constants.ParameterCode.ClientAuthenticationParams,n),s&&p.push(t.Constants.ParameterCode.ClientAuthenticationData,s)),i&&p.push(t.Constants.ParameterCode.UserId,i),p.push(t.Constants.ParameterCode.Region,a),this.sendOperation(t.Constants.OperationCode.Authenticate,p,!0,0),this._logger.info("Authenticate...")},o}(p);t.NameServerPeer=d;var c=function(e){function o(t,o,r){e.call(this,o,r,"Master"),this.client=t}return __extends(o,e),o.prototype.onUnhandledEvent=function(e,o){this.client.onEvent(e,o.vals[t.Constants.ParameterCode.CustomEventContent],o.vals[t.Constants.ParameterCode.ActorNr])},o.prototype.onUnhandledResponse=function(e,t){this.client.onOperationResponse(t.errCode,t.errMsg,e,t.vals)
},o.prototype.findFriends=function(e){var o=[];o.push(t.Constants.ParameterCode.FindFriendsRequestList),o.push(e),this.sendOperation(t.Constants.OperationCode.FindFriends,o)},o.prototype.requestLobbyStats=function(e){var o=[];if(e&&e.length>0){for(var r=new Array,n=new Array,s=0;s<e.length;++s)r[s]=e[s][0],n[s]=e[s][1];o.push(t.Constants.ParameterCode.LobbyName),o.push(r),o.push(t.Constants.ParameterCode.LobbyType),o.push(n)}this.sendOperation(t.Constants.OperationCode.LobbyStats,o)},o}(p);t.MasterPeer=c;var u=function(e){function o(t,o,r){e.call(this,o,r,"Game"),this.client=t}return __extends(o,e),o.prototype.onUnhandledEvent=function(e,o){this.client.onEvent(e,o.vals[t.Constants.ParameterCode.CustomEventContent],o.vals[t.Constants.ParameterCode.ActorNr])},o.prototype.onUnhandledResponse=function(e,t){this.client.onOperationResponse(t.errCode,t.errMsg,e,t.vals)},o.prototype.raiseEvent=function(e,o,r){if(!this.client.isJoinedToRoom())throw new Error("raiseEvent - Not joined!");this._logger.debug("raiseEvent",e,o,r);var n=[t.Constants.ParameterCode.Code,e,t.Constants.ParameterCode.Data,o];if(r){if(void 0!=r.receivers&&r.receivers!==t.Constants.ReceiverGroup.Others&&(n.push(t.Constants.ParameterCode.ReceiverGroup),n.push(r.receivers)),void 0!=r.cache&&r.cache!==t.Constants.EventCaching.DoNotCache&&(n.push(t.Constants.ParameterCode.Cache),n.push(r.cache)),void 0!=r.interestGroup){if(!this.checkGroupNumber(r.interestGroup))throw new Error("raiseEvent - Group not a number: "+r.interestGroup);n.push(t.Constants.ParameterCode.Group),n.push(r.interestGroup)}void 0!=r.targetActors&&(n.push(t.Constants.ParameterCode.ActorList),n.push(r.targetActors)),r.webForward&&(n.push(t.Constants.ParameterCode.Forward),n.push(!0))}this.sendOperation(t.Constants.OperationCode.RaiseEvent,n)},o.prototype.changeGroups=function(e,o){var r=[];null!=e&&void 0!=e&&(this.checkGroupArray(e,"groupsToRemove"),r.push(t.Constants.ParameterCode.Remove),r.push(e)),null!=o&&void 0!=o&&(this.checkGroupArray(o,"groupsToAdd"),r.push(t.Constants.ParameterCode.Add),r.push(o)),this.sendOperation(t.Constants.OperationCode.ChangeGroups,r)},o.prototype.checkGroupNumber=function(e){return!("number"!=typeof e||isNaN(e)||e===1/0||e===-(1/0))},o.prototype.checkGroupArray=function(e,t){if(!Exitgames.Common.Util.isArray(e))throw new Error("changeGroups - groupsToRemove not an array: "+e);for(var o=0;o<e.length;++o){var r=e[o];if(!this.checkGroupNumber(r))throw new Error("changeGroups - "+t+" ("+e+") not an array of numbers: element "+o+" = "+r)}},o}(p);t.GamePeer=u}(t=e.LoadBalancing||(e.LoadBalancing={}))}(Photon||(Photon={}));var Photon;!function(e){var t;!function(e){var t;!function(e){function t(t){return Exitgames.Common.Util.getEnumKeyByValue(e.UserStatus,t)}e.ParameterCode={Channels:0,Channel:1,Messages:2,Message:3,Senders:4,Sender:5,ChannelUserCount:6,UserId:225,MsgId:8,MsgIds:9,SubscribeResults:15,Status:10,Friends:11,SkipMessage:12,HistoryLength:14},e.OperationCode={Subscribe:0,Unsubscribe:1,Publish:2,SendPrivate:3,ChannelHistory:4,UpdateStatus:5,AddFriendds:6,RemoveFriends:7},e.EventCode={ChatMessages:0,Users:1,PrivateMessage:2,FriendsList:3,StatusUpdate:4,Subscribe:5,Unsubscribe:6},e.UserStatus={Offline:0,Invisible:1,Online:2,Away:3,Dnd:4,Lfg:5,Playing:6},e.UserStatusToName=t}(t=e.Constants||(e.Constants={}))}(t=e.Chat||(e.Chat={}))}(Photon||(Photon={}));var Photon;!function(e){var t;!function(t){var o=function(){function e(e,t){this.sender=e,this.content=t}return e.prototype.getSender=function(){return this.sender},e.prototype.getContent=function(){return this.content},e}();t.Message=o;var r=function(){function e(e,t){this.name=e,this.isPrivat=t,this.messages=[]}return e.prototype.getName=function(){return this.name},e.prototype.isPrivate=function(){return this.isPrivat},e.prototype.getMessages=function(){return this.messages},e.prototype.clearMessages=function(){this.messages.splice(0)},e.prototype.addMessage=function(e){this.messages.push(e)},e.prototype.addMessages=function(e,t){var r=[];for(var n in e)if(parseInt(n)<t.length){var s=new o(e[n],t[n]);this.addMessage(s),r.push(s)}return r},e}();t.Channel=r;var n=function(e){function n(t,o,r){e.call(this,t,o,r),this.publicChannels={},this.privateChannels={},this.subscribeRequests=[],this.unsubscribeRequests=[],this.autoJoinLobby=!1}return __extends(n,e),n.prototype.onStateChange=function(e){},n.prototype.onError=function(e,t){},n.prototype.onSubscribeResult=function(e){},n.prototype.onUnsubscribeResult=function(e){},n.prototype.onChatMessages=function(e,t){},n.prototype.onPrivateMessage=function(e,t){},n.prototype.onUserStatusUpdate=function(e,t,o,r){},n.prototype.connectToRegionFrontEnd=function(e){return this.connectToRegionMaster(e)},n.prototype.isConnectedToFrontEnd=function(){return this.state==n.ChatState.ConnectedToFrontEnd},n.prototype.subscribe=function(e,o){if(void 0===o&&(o=0),this.isConnectedToFrontEnd()){this.logger.debug("Subscribe channels:",e);var r=[];return r.push(t.Constants.ParameterCode.Channels,e),void 0!=o&&0!=o&&r.push(t.Constants.ParameterCode.HistoryLength,o),this.masterPeer.sendOperation(t.Constants.OperationCode.Subscribe,r),!0}return this.logger.error("subscribe request error:","Not connected to Front End"),!1},n.prototype.unsubscribe=function(e){if(this.isConnectedToFrontEnd()){this.logger.debug("Unsubscribe channels:",e);var o=[];return o.push(t.Constants.ParameterCode.Channels,e),this.masterPeer.sendOperation(t.Constants.OperationCode.Unsubscribe,o),!0}return this.logger.error("unsubscribe request error:","Not connected to Front End"),!1},n.prototype.publishMessage=function(e,o){if(this.isConnectedToFrontEnd()){var r=[];return r.push(t.Constants.ParameterCode.Channel,e),r.push(t.Constants.ParameterCode.Message,o),this.masterPeer.sendOperation(t.Constants.OperationCode.Publish,r),!0}return this.logger.error("publishMessage request error:","Not connected to Front End"),!1},n.prototype.sendPrivateMessage=function(e,o){if(this.isConnectedToFrontEnd()){var r=[];return r.push(t.Constants.ParameterCode.UserId,e),r.push(t.Constants.ParameterCode.Message,o),this.masterPeer.sendOperation(t.Constants.OperationCode.SendPrivate,r),!0}return this.logger.error("sendPrivateMessage request error:","Not connected to Front End"),!1},n.prototype.setUserStatus=function(e,o,r){if(void 0===o&&(o=null),void 0===r&&(r=!1),this.isConnectedToFrontEnd()){var n=[];return n.push(t.Constants.ParameterCode.Status,e),r?n.push(t.Constants.ParameterCode.SkipMessage,!0):n.push(t.Constants.ParameterCode.Message,o),this.masterPeer.sendOperation(t.Constants.OperationCode.UpdateStatus,n),!0}return this.logger.error("setUserStatus request error:","Not connected to Front End"),!1},n.prototype.addFriends=function(e){if(this.isConnectedToFrontEnd()){var o=[];return o.push(t.Constants.ParameterCode.Friends,e),this.masterPeer.sendOperation(t.Constants.OperationCode.AddFriendds,o),!0}return this.logger.error("addFriends request error:","Not connected to Front End"),!1},n.prototype.removeFriends=function(e){if(this.isConnectedToFrontEnd()){var o=[];return o.push(t.Constants.ParameterCode.Friends,e),this.masterPeer.sendOperation(t.Constants.OperationCode.RemoveFriends,o),!0}return this.logger.error("removeFriends request error:","Not connected to Front End"),!1},n.prototype.getPublicChannels=function(){return this.publicChannels},n.prototype.getPrivateChannels=function(){return this.privateChannels},n.prototype.getOrAddChannel=function(e,t,o){return void 0==e[t]&&(e[t]=new r(t,o)),e[t]},n.prototype.initMasterPeer=function(r){var n=this;e.prototype.initMasterPeer.call(this,r),r.addEventListener(t.Constants.EventCode.ChatMessages,function(e){var o=e.vals[t.Constants.ParameterCode.Senders],s=e.vals[t.Constants.ParameterCode.Messages],i=e.vals[t.Constants.ParameterCode.Channel],a=n.publicChannels[i];if(a){var p=a.addMessages(o,s);n.onChatMessages(i,p)}else r._logger.warn("ev ChatMessages: Got message from unsubscribed channel ",i)}),r.addEventListener(t.Constants.EventCode.PrivateMessage,function(e){var r=e.vals[t.Constants.ParameterCode.Sender],s=e.vals[t.Constants.ParameterCode.Message],i=e.vals[t.Constants.ParameterCode.UserId],a="";a=n.getUserId()==r?i:r;n.getOrAddChannel(n.privateChannels,a,!0);n.onPrivateMessage(a,new o(r,s))}),r.addEventListener(t.Constants.EventCode.StatusUpdate,function(e){var o=e.vals[t.Constants.ParameterCode.Sender],r=e.vals[t.Constants.ParameterCode.Status],s=e.vals[t.Constants.ParameterCode.Message],i=void 0!==s;n.onUserStatusUpdate(o,r,i,s)}),r.addEventListener(t.Constants.EventCode.Subscribe,function(e){r._logger.debug("ev Subscribe",e);var o={},s=e.vals[t.Constants.ParameterCode.Channels]||[],i=e.vals[t.Constants.ParameterCode.SubscribeResults]||[];for(var a in s){var p=s[a];o[p]=!1,a<i.length&&i[a]&&(n.getOrAddChannel(n.publicChannels,p,!1),o[p]=!0)}n.onSubscribeResult(o)}),r.addEventListener(t.Constants.EventCode.Unsubscribe,function(e){r._logger.debug("ev Unsubscribe",e);var o={},s=e.vals[t.Constants.ParameterCode.Channels]||[];for(var i in s){var a=s[i];delete n.publicChannels[a],o[a]=!0}n.onUnsubscribeResult(o)})},n.StateToName=function(e){var t=Exitgames.Common.Util.getEnumKeyByValue(n.ChatState,e);return void 0===t?Exitgames.Common.Util.getEnumKeyByValue(n.State,e):t},n.ChatPeerErrorCode={Ok:0,FrontEndError:1001,FrontEndConnectFailed:1002,FrontEndConnectClosed:1003,FrontEndTimeout:1004,FrontEndEncryptionEstablishError:1005,FrontEndAuthenticationFailed:1101,NameServerError:3001,NameServerConnectFailed:3002,NameServerConnectClosed:3003,NameServerTimeout:3004,NameServerEncryptionEstablishError:300,NameServerAuthenticationFailed:3101},n.ChatState={Error:-1,Uninitialized:0,ConnectingToNameServer:1,ConnectedToNameServer:2,ConnectingToFrontEnd:3,ConnectedToFrontEnd:4,Disconnected:10},n}(e.LoadBalancing.LoadBalancingClient);t.ChatClient=n}(t=e.Chat||(e.Chat={}))}(Photon||(Photon={}));